{% extends "base.html" %}

{% block styles %}
<style>
  /* Vue Notification Styles */
  .notifications {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    max-width: 350px;
  }

  .notification {
    background: white;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    margin-bottom: 8px;
    padding: 12px 16px;
    display: flex;
    align-items: center;
    border-left: 4px solid #ddd;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .notification.success {
    border-left-color: #28a745;
  }

  .notification.error {
    border-left-color: #dc3545;
  }

  .notification.warning {
    border-left-color: #ffc107;
  }

  .notification.info {
    border-left-color: #17a2b8;
  }

  .notification-icon {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 10px;
    font-size: 12px;
    font-weight: bold;
    color: white;
  }

  .notification.success .notification-icon {
    background: #28a745;
  }

  .notification.error .notification-icon {
    background: #dc3545;
  }

  .notification.warning .notification-icon {
    background: #ffc107;
  }

  .notification.info .notification-icon {
    background: #17a2b8;
  }

  .notification-text {
    flex: 1;
    font-size: 14px;
    color: #333;
  }

  .notification-close {
    background: none;
    border: none;
    font-size: 16px;
    color: #999;
    cursor: pointer;
    padding: 0;
    margin-left: 8px;
  }

  .notification-close:hover {
    color: #666;
  }
</style>
{% endblock %}

{% block content %}
<!-- Home Page -->
<div v-if="route === 'monitor'">
  <div class="card">
    <h3>Create Subscription</h3>
    <div class="row">
      <input class="input" placeholder="Name *" v-model="form.name" required>
      <select class="input" v-model="form.coin" required>
        <option value="">Select Coin *</option>
        <option value="ETH">ETH</option>
      </select>
      <select class="input" v-model="form.interval" required>
        <option value="">Select Interval *</option>
        <option value="1m">1m</option>
        <option value="5m">5m</option>
        <option value="15m">15m</option>
        <option value="1h">1h</option>
      </select>
      <select class="input" v-model="form.account_alias" required>
        <option value="">Select Account *</option>
        {% raw %}<option v-for="a in accounts" :key="a.id" :value="a.alias">{{ a.alias }}</option>{% endraw %}
      </select>
      <button class="btn" @click="createSubscription">Create</button>
      <button class="btn ghost" @click="clearAll">Pause / Clear</button>
      <button class="btn" @click="testNotification" style="background: #007bff;">Test Notification</button>
    </div>
  </div>

  <div class="card">
    <div class="stat">
      <div class="kpi"><div class="value">{{ 'Yes' if status.ws_ready else 'No' }}</div><div class="label">WS Ready</div></div>
      <div class="kpi"><div class="value">{{ status.active_subscriptions }}</div><div class="label">Active</div></div>
      <div class="kpi"><div class="value">{{ status.subscription_stats.total if status.subscription_stats else 0 }}</div><div class="label">Total</div></div>
    </div>
  </div>

  <div class="card">
    <h3>Current Subscriptions</h3>
    <table class="table">
      <thead><tr><th>ID</th><th>Type</th><th>Status</th><th>Action</th></tr></thead>
      <tbody>
        {% raw %}<tr v-for="s in subs" :key="s.id">
          <td>{{ s.id }}</td>
          <td>{{ s.type }}</td>
          <td>{{ s.status }}</td>
          <td>
            <button class="btn danger" @click="removeSub(s.id)">Delete</button>
            <button class="btn ghost" v-if="s.status==='error'" @click="retrySub(s.id)" style="margin-left:8px">Retry</button>
          </td>
        </tr>{% endraw %}
      </tbody>
    </table>
  </div>
</div>

<!-- Accounts Page -->
<div v-if="route === 'account'">
  <div class="card">
    <h3>Create / Update Account</h3>
    <div class="row">
      <input class="input" placeholder="Alias" v-model="accountForm.alias">
      <input class="input" placeholder="API Wallet Address" v-model="accountForm.api_wallet_address">
      <input class="input" placeholder="Secret Key" v-model="accountForm.secret_key">
      <button class="btn" @click="saveAccount">Save</button>
    </div>
  </div>
  <div class="card">
    <h3>Account List</h3>
    <table class="table">
      <thead><tr><th>Alias</th><th>Account Address</th><th>API Wallet</th><th>Active</th><th>Action</th></tr></thead>
      <tbody>
        {% raw %}<tr v-for="a in accounts" :key="a.id">
          <td>{{ a.alias }}</td>
          <td>{{ a.account_address }}</td>
          <td>{{ a.api_wallet_address }}</td>
          <td>{{ 'Yes' if a.is_active else 'No' }}</td>
          <td><button class="btn danger" @click="deleteAccount(a.alias)">Delete</button></td>
        </tr>{% endraw %}
      </tbody>
    </table>
  </div>
</div>

<!-- Settings Page -->
<div v-if="route === 'settings'">
  <div class="card">
    <h3>Create / Update Config</h3>
    <div class="row">
      <input class="input" placeholder="key" v-model="configForm.key">
      <input class="input" placeholder="value" v-model="configForm.value">
      <input class="input" placeholder="description" v-model="configForm.description">
      <input class="input" placeholder="config_type" v-model="configForm.config_type">
      <button class="btn" @click="saveConfig">Save</button>
    </div>
  </div>
  <div class="card">
    <h3>Config List</h3>
    <table class="table">
      <thead><tr><th>Key</th><th>Value</th><th>Type</th><th>Description</th><th>Action</th></tr></thead>
      <tbody>
        {% raw %}<tr v-for="c in configs" :key="c.id">
          <td>{{ c.key }}</td>
          <td style="max-width:360px;overflow:auto">{{ c.value }}</td>
          <td>{{ c.config_type }}</td>
          <td>{{ c.description }}</td>
          <td><button class="btn danger" @click="deleteConfig(c.key)">Delete</button></td>
        </tr>{% endraw %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
// API 工具类
class ApiResponse {
  static handle(response, onSuccess, onError) {
    if (response && response.code === 0) {
      if (onSuccess) onSuccess(response.data || {});
    } else {
      const msg = (response && response.message) || 'Unknown error';
      if (onError) {
        onError(msg);
      } else {
        alert(msg);
      }
    }
  }
  
  static isSuccess(r) { 
    return r && r.code === 0; 
  }
  
  static getData(r) { 
    return (r && r.code === 0) ? r.data : null; 
  }
  
  static getErrorMessage(r) {
    return (r && r.code !== 0) ? r.message : null;
  }
}

class ApiClient {
  static async get(url, options = {}) {
    try {
      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          ...(options.headers || {})
        },
        ...options
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      return await response.json();
    } catch (error) {
      console.error('API请求失败:', error);
      return { code: -1, message: error.message, data: null };
    }
  }

  static async post(url, data = null, options = {}) {
    try {
      const isFormData = data instanceof FormData;
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          ...(isFormData ? {} : { 'Content-Type': 'application/json' }),
          ...(options.headers || {})
        },
        body: isFormData ? data : JSON.stringify(data),
        ...options
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      return await response.json();
    } catch (error) {
      console.error('API请求失败:', error);
      return { code: -1, message: error.message, data: null };
    }
  }

  static async delete(url, options = {}) {
    try {
      const response = await fetch(url, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          ...(options.headers || {})
        },
        ...options
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      return await response.json();
    } catch (error) {
      console.error('API请求失败:', error);
      return { code: -1, message: error.message, data: null };
    }
  }
}

// API 接口
const api = {
  async status() { return ApiClient.get('/system/status'); },
  async subs() { return ApiClient.get('/subscriptions/'); },
  async createSubscription(params) { return ApiClient.post('/subscriptions/', params); },
  async removeSub(id) { return ApiClient.delete(`/subscriptions/${id}`); },
  async retrySub(id) { return ApiClient.post(`/subscriptions/${id}/retry`); },
  async clearAll() { return ApiClient.delete('/subscriptions/'); },
  async listConfigs() { return ApiClient.get('/configs/'); },
  async upsertConfig(payload) { return ApiClient.post('/configs/', payload); },
  async deleteConfig(key) { return ApiClient.delete(`/configs/${key}`); },
  async listAccounts() { return ApiClient.get('/accounts/'); },
  async upsertAccount(payload) { return ApiClient.post('/accounts/', payload); },
  async deleteAccount(alias) { return ApiClient.delete(`/accounts/${alias}`); },
};

// Vue 应用
const { createApp, reactive, onMounted, toRefs, nextTick } = Vue;

createApp({
  setup() {
    const state = reactive({
      route: (location.hash.replace('#/', '') || 'monitor'),
      status: { ws_ready: false, active_subscriptions: 0, subscription_stats: { total: 0 } },
      subs: [],
      configs: [],
      accounts: [],
      form: { name: '', coin: '', interval: '', account_alias: '' },
      accountForm: { alias: '', api_wallet_address: '', secret_key: '', is_active: true },
      configForm: { key: '', value: '', description: '', config_type: 'string' },
      notifications: []
    });

    const setRoute = () => { 
      state.route = (location.hash.replace('#/', '') || 'monitor'); 
      updateActiveTab();
    };
    window.addEventListener('hashchange', setRoute);
    
    const updateActiveTab = () => {
      const tabs = document.querySelectorAll('.nav a');
      tabs.forEach(tab => {
        tab.classList.remove('active');
        const href = tab.getAttribute('href');
        if (href === `#/${state.route}`) {
          tab.classList.add('active');
        }
      });
    };

    const refreshMonitor = async () => {
      const statusRes = await api.status();
      if (ApiResponse.isSuccess(statusRes)) {
        state.status = ApiResponse.getData(statusRes);
      }
      
      const subsRes = await api.subs();
      if (ApiResponse.isSuccess(subsRes)) {
        state.subs = ApiResponse.getData(subsRes);
      }
    };

    const refreshConfigs = async () => { 
      const res = await api.listConfigs(); 
      if (ApiResponse.isSuccess(res)) {
        state.configs = ApiResponse.getData(res);
      }
    };
    
    const refreshAccounts = async () => { 
      const res = await api.listAccounts(); 
      if (ApiResponse.isSuccess(res)) {
        state.accounts = ApiResponse.getData(res);
      }
    };

    const refreshAll = async () => {
      await Promise.all([refreshMonitor(), refreshConfigs(), refreshAccounts()]);
    };

    // Notification methods
    const showNotification = (message, type = 'info', duration = 4000) => {
      const id = Date.now() + Math.random();
      const notification = { id, message, type };
      state.notifications.push(notification);
      
      if (duration > 0) {
        setTimeout(() => {
          removeNotification(id);
        }, duration);
      }
    };

    const removeNotification = (id) => {
      const index = state.notifications.findIndex(n => n.id === id);
      if (index > -1) {
        state.notifications.splice(index, 1);
      }
    };

    // Convenience methods
    const showSuccess = (message) => showNotification(message, 'success');
    const showError = (message) => showNotification(message, 'error');
    const showWarning = (message) => showNotification(message, 'warning');
    const showInfo = (message) => showNotification(message, 'info');

    // Test notification method
    const testNotification = () => {
      showSuccess('This is a success notification!');
      setTimeout(() => showError('This is an error notification!'), 500);
      setTimeout(() => showWarning('This is a warning notification!'), 1000);
      setTimeout(() => showInfo('This is an info notification!'), 1500);
    };

    // Home page methods
    const createSubscription = async () => {
      if (!state.form.name || !state.form.coin || !state.form.interval || !state.form.account_alias) {
        showError('Please fill in all required fields: Name, Coin, Interval, and Account');
        return;
      }
      
      const params = {
        type: 'candle',
        coin: state.form.coin,
        interval: state.form.interval,
        account_alias: state.form.account_alias
      };
      
      const res = await api.createSubscription(params);
      if (!ApiResponse.isSuccess(res)) {
        showError(ApiResponse.getErrorMessage(res) || 'Create failed');
        return;
      }
      
      showSuccess('Subscription created successfully!');
      state.form = { name: '', coin: '', interval: '', account_alias: '' };
      await refreshAll();
    };
    
    const clearAll = async () => {
      const res = await api.clearAll();
      if (ApiResponse.isSuccess(res)) {
        showSuccess('All subscriptions cleared successfully!');
        await refreshAll();
      } else {
        showError(ApiResponse.getErrorMessage(res) || 'Clear failed');
      }
    };
    
    const removeSub = async (id) => {
      const res = await api.removeSub(id);
      if (ApiResponse.isSuccess(res)) {
        showSuccess('Subscription deleted successfully!');
        await refreshAll();
      } else {
        showError(ApiResponse.getErrorMessage(res) || 'Delete failed');
      }
    };
    
    const retrySub = async (id) => {
      const res = await api.retrySub(id);
      if (ApiResponse.isSuccess(res)) {
        showSuccess('Subscription retried successfully!');
        await refreshAll();
      } else {
        showError(ApiResponse.getErrorMessage(res) || 'Retry failed');
      }
    };

    // Account page methods
    const saveAccount = async () => {
      const res = await api.upsertAccount(state.accountForm);
      if (ApiResponse.isSuccess(res)) {
        showSuccess('Account saved successfully!');
        state.accountForm = { alias: '', api_wallet_address: '', secret_key: '', is_active: true };
        await refreshAll();
      } else {
        showError(ApiResponse.getErrorMessage(res) || 'Save failed');
      }
    };
    
    const deleteAccount = async (alias) => {
      const res = await api.deleteAccount(alias);
      if (ApiResponse.isSuccess(res)) {
        showSuccess('Account deleted successfully!');
        await refreshAll();
      } else {
        showError(ApiResponse.getErrorMessage(res) || 'Delete failed');
      }
    };

    // Settings page methods
    const saveConfig = async () => {
      const res = await api.upsertConfig(state.configForm);
      if (ApiResponse.isSuccess(res)) {
        showSuccess('Config saved successfully!');
        state.configForm = { key: '', value: '', description: '', config_type: 'string' };
        await refreshAll();
      } else {
        showError(ApiResponse.getErrorMessage(res) || 'Save failed');
      }
    };
    
    const deleteConfig = async (key) => {
      const res = await api.deleteConfig(key);
      if (ApiResponse.isSuccess(res)) {
        showSuccess('Config deleted successfully!');
        await refreshAll();
      } else {
        showError(ApiResponse.getErrorMessage(res) || 'Delete failed');
      }
    };

    onMounted(async () => {
      await refreshAll();
      
      nextTick(() => {
        const tabs = document.querySelectorAll('.nav a');
        tabs.forEach(tab => {
          tab.addEventListener('click', (e) => {
            e.preventDefault();
            const href = tab.getAttribute('href');
            if (href) {
              location.hash = href;
              setRoute();
            }
          });
        });
        
        updateActiveTab();
      });
    });

    return { 
      ...toRefs(state),
      refreshAll,
      createSubscription,
      clearAll,
      removeSub,
      retrySub,
      saveAccount,
      deleteAccount,
      saveConfig,
      deleteConfig,
      removeNotification,
      showNotification,
      showSuccess,
      showError,
      showWarning,
      showInfo,
      testNotification
    };
  }
}).mount('#app');
{% endblock %}
